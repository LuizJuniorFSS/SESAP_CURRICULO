# Script para configurar tarefa agendada no Windows
# Executa o upload autom√°tico para GitHub a cada minuto

# Verifica se est√° executando como administrador
if (-NOT ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Write-Host "ERRO: Este script precisa ser executado como Administrador!" -ForegroundColor Red
    Write-Host "Clique com o bot√£o direito no PowerShell e selecione 'Executar como administrador'" -ForegroundColor Yellow
    pause
    exit 1
}

# Define vari√°veis
$taskName = "AutoGitUpload-SESAP"
$scriptPath = "C:\xampp\htdocs\sesap_curriculo\auto-git-upload.ps1"
$workingDirectory = "C:\xampp\htdocs\sesap_curriculo"

try {
    Write-Host "Configurando tarefa agendada para upload autom√°tico..." -ForegroundColor Green
    
    # Remove tarefa existente se houver
    $existingTask = Get-ScheduledTask -TaskName $taskName -ErrorAction SilentlyContinue
    if ($existingTask) {
        Write-Host "Removendo tarefa existente..." -ForegroundColor Yellow
        Unregister-ScheduledTask -TaskName $taskName -Confirm:$false
    }
    
    # Cria a a√ß√£o da tarefa
    $action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-WindowStyle Hidden -ExecutionPolicy Bypass -File `"$scriptPath`"" -WorkingDirectory $workingDirectory
    
    # Cria o gatilho (a cada 1 minuto)
    $trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) -RepetitionInterval (New-TimeSpan -Minutes 1) -RepetitionDuration (New-TimeSpan -Days 365)
    
    # Configura as configura√ß√µes da tarefa
    $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable -RunOnlyIfNetworkAvailable
    
    # Cria o principal (usu√°rio atual)
    $principal = New-ScheduledTaskPrincipal -UserId $env:USERNAME -LogonType Interactive
    
    # Registra a tarefa
    Register-ScheduledTask -TaskName $taskName -Action $action -Trigger $trigger -Settings $settings -Principal $principal -Description "Upload autom√°tico para GitHub do projeto SESAP Curr√≠culo a cada minuto"
    
    Write-Host "‚úÖ Tarefa agendada criada com sucesso!" -ForegroundColor Green
    Write-Host "Nome da tarefa: $taskName" -ForegroundColor Cyan
    Write-Host "Frequ√™ncia: A cada 1 minuto" -ForegroundColor Cyan
    Write-Host "Script: $scriptPath" -ForegroundColor Cyan
    
    Write-Host "`nüìã Para gerenciar a tarefa:" -ForegroundColor Yellow
    Write-Host "‚Ä¢ Abra o 'Agendador de Tarefas' do Windows" -ForegroundColor White
    Write-Host "‚Ä¢ Procure por '$taskName' na lista" -ForegroundColor White
    Write-Host "‚Ä¢ Voc√™ pode pausar, retomar ou excluir a tarefa conforme necess√°rio" -ForegroundColor White
    
    Write-Host "`nüîß Para parar a automa√ß√£o:" -ForegroundColor Yellow
    Write-Host "Execute: Disable-ScheduledTask -TaskName '$taskName'" -ForegroundColor White
    
    Write-Host "`nüîÑ Para reativar a automa√ß√£o:" -ForegroundColor Yellow
    Write-Host "Execute: Enable-ScheduledTask -TaskName '$taskName'" -ForegroundColor White
    
} catch {
    Write-Host "‚ùå ERRO ao configurar tarefa agendada: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}

Write-Host "`n‚ú® Configura√ß√£o conclu√≠da! O upload autom√°tico come√ßar√° em 1 minuto." -ForegroundColor Green